<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Subir archivos</title>

  <!-- Bootstrap CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <div class="container py-4">
    <h4 class="mb-4 text-center">üì§ Subir archivos</h4>

    <form id="uploadForm">
      <div class="mb-3">
        <label class="form-label">Nombre del estudiante</label>
        <input type="text" class="form-control" id="studentName" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Materia</label>
        <input type="text" class="form-control" id="materia" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Fecha</label>
        <input type="date" class="form-control" id="fecha" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Archivos</label>
        <input type="file" class="form-control" id="files" multiple required>
      </div>

      <button type="submit" class="btn btn-primary w-100">
        Subir
      </button>
    </form>

    <div id="message" class="mt-3 text-center"></div>
  </div>

  <script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyh8wP590G697WiiLdOGG1r3FhafisqXIuRfPNdHvznLx5UnJhZLm9MdrN8JdjsKbQ/exec";
  
  const form = document.getElementById("uploadForm");
  const messageDiv = document.getElementById("message");
  
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    messageDiv.innerHTML = "‚è≥ Subiendo archivos...";
  
    try {
      const filesInput = document.getElementById("files");
      const files = filesInput.files;
  
      if (!files.length) {
        showError("Debes seleccionar al menos un archivo.");
        return;
      }
  
      const filesBase64 = [];
  
      for (const file of files) {
        const base64 = await fileToBase64(file);
        filesBase64.push({
          name: file.name,
          type: file.type,
          data: base64
        });
      }
  
      const payload = {
        action: "upload",
        email: "williamqq@gmail.com",
        pin: "2910",
        fecha: document.getElementById("fecha").value,
        materia: document.getElementById("materia").value,
        studentName: document.getElementById("studentName").value,
        files: filesBase64
      };
  
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
  
      const result = await response.json();
  
      if (!result.success) {
        showError(result.error || "Ocurri√≥ un error inesperado.");
        return;
      }
  
      messageDiv.innerHTML = "‚úÖ Archivos subidos correctamente";
      form.reset();
  
    } catch (err) {
      console.error(err);
      showError("No se pudo subir el archivo. Intenta nuevamente.");
    }
  });
  
  function showError(text) {
    messageDiv.innerHTML = `<div class="alert alert-danger">${text}</div>`;
  }
  
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        // quitar "data:image/png;base64,"
        const base64 = reader.result.split(",")[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
</script>


<button id="test">Test POST</button>

<script>
document.getElementById('test').onclick = async () => {
  const fd = new FormData();
  fd.append('test', 'ok');

  try {
    const res = await fetch('https://script.google.com/macros/s/AKfycbyh8wP590G697WiiLdOGG1r3FhafisqXIuRfPNdHvznLx5UnJhZLm9MdrN8JdjsKbQ/exec', {
      method: 'POST',
      body: fd
    });
    const text = await res.text();
    console.log(text);
  } catch (e) {
    console.error('FETCH ERROR', e);
  }
};
</script>


  

</body>
</html>
